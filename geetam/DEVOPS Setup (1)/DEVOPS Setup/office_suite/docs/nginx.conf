# upstream backend {
#     server app-prod:8000;
# }

# upstream frontend {
#     server frontend-production:3000;
# }

# upstream minio {
#     server minio:9000;
# }

# server {
#     listen 80;
#     server_name localhost;
#     charset utf-8;
#     client_max_body_size 100M;

#     # Security headers
#     add_header X-Frame-Options DENY always;
#     add_header X-Content-Type-Options nosniff always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
#     # Gzip compression
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1000;
#     gzip_types
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/xml+rss
#         application/javascript
#         application/json
#         image/svg+xml;

#     # Static files
#     location /static/ {
#         alias /data/static/;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#     }

#     # API routes
#     location /api/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
        
#         # Timeouts
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#     }

#     # Admin routes
#     location /admin/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
#     }

#     # Authentication routes
#     location /oidc/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
#     }

#     # Media files with auth
#     # location /media/ {
#     #     # Auth request configuration
#     #     auth_request /media-auth;
#     #     auth_request_set $authHeader $upstream_http_authorization;
#     #     auth_request_set $authDate $upstream_http_x_amz_date;
#     #     auth_request_set $authContentSha256 $upstream_http_x_amz_content_sha256;

#     #     # Pass specific headers from the auth response
#     #     proxy_set_header Authorization $authHeader;
#     #     proxy_set_header X-Amz-Date $authDate;
#     #     proxy_set_header X-Amz-Content-SHA256 $authContentSha256;

#     #     # Get resource from Minio
#     #     proxy_pass http://minio/grow24-office-docs-media-storage/;
#     #     proxy_set_header Host minio:9000;

#     #     add_header Content-Security-Policy "default-src 'none'" always;
#     #     add_header Cache-Control "private, max-age=3600";
#     # }

#     # location /media-auth {
#     #     internal;
#     #     proxy_pass http://backend/api/v1.0/documents/media-auth/;
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Original-URL $request_uri;
        
#     #     # Prevent the body from being passed
#     #     proxy_pass_request_body off;
#     #     proxy_set_header Content-Length "";
#     #     proxy_set_header X-Original-Method $request_method;
#     # }

#     location /media/ {
#         auth_request /media-auth;
#         auth_request_set $authHeader $upstream_http_authorization;
#         auth_request_set $authDate $upstream_http_x_amz_date;
#         auth_request_set $authContentSha256 $upstream_http_x_amz_content_sha256;

#         proxy_set_header Authorization $authHeader;
#         proxy_set_header X-Amz-Date $authDate;
#         proxy_set_header X-Amz-Content-SHA256 $authContentSha256;

#         proxy_pass http://minio/grow24-office-docs-media-storage/;
#         proxy_set_header Host minio:9000;

#         add_header Content-Security-Policy "img-src 'self' http://118.139.165.145:20009 https://docs.intelligentsalesman.com;" always;
#         add_header Cache-Control "private, max-age=3600";
#     }

#     # location /media-auth {
#     #     internal;
#     #     proxy_pass http://backend/api/v1.0/documents/media-auth/;
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Original-URL $request_uri;
#     #     proxy_pass_request_body off;
#     #     proxy_set_header Content-Length "";
#     #     proxy_set_header X-Original-Method $request_method;
#     # }

#     location /media-auth {
#         internal;
#         proxy_pass http://backend/api/v1.0/documents/media-auth/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Original-URL $request_uri;
#         proxy_pass_request_body off;
#         proxy_set_header Content-Length "";
#         proxy_set_header X-Original-Method $request_method;
#         proxy_set_header X-Forwarded-Proto http; # Force HTTP
#         error_log /var/log/nginx/media-auth.log debug;
#     }

#     location /collaboration-auth {
#         internal;
#         proxy_pass http://backend/api/v1.0/collaboration-auth/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_pass_request_body off;
#         proxy_set_header Content-Length "";
#         proxy_set_header X-Original-Method $request_method;
#         proxy_set_header X-Forwarded-Proto http; # Force HTTP
#         error_log /var/log/nginx/collab-auth.log debug;
#     }

#     # # Collaboration WebSocket
#     # location /collaboration/ws/ {
#     #     proxy_pass http://y-provider-production:4444;
#     #     proxy_http_version 1.1;
#     #     proxy_set_header Upgrade $http_upgrade;
#     #     proxy_set_header Connection "upgrade";
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Forwarded-Proto $scheme;
#     #     proxy_cache_bypass $http_upgrade;
#     # }

#     # # Collaboration API
#     # location /collaboration/ {
#     #     proxy_pass http://y-provider-production:4444;
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_set_header X-Forwarded-Proto $scheme;
#     # }

#     location /collaboration/ws/ {
#         auth_request /collaboration-auth;
#         proxy_pass http://y-provider-production:4444;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }

#     location /collaboration/ {
#         auth_request /collaboration-auth;
#         proxy_pass http://y-provider-production:4444;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }

#     # location /collaboration-auth {
#     #     internal;
#     #     proxy_pass http://backend/api/v1.0/collaboration-auth/; # Assume this endpoint exists
#     #     proxy_set_header Host $host;
#     #     proxy_set_header X-Real-IP $remote_addr;
#     #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     #     proxy_pass_request_body off;
#     #     proxy_set_header Content-Length "";
#     #     proxy_set_header X-Original-Method $request_method;
#     # }

#     # Health checks
#     location /health {
#         access_log off;
#         return 200 "healthy\n";
#         add_header Content-Type text/plain;
#     }

#     # Frontend (catch-all)
#     location / {
#         proxy_pass http://frontend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_redirect off;
        
#         # Handle frontend routing
#         try_files $uri $uri/ @frontend;
#     }

#     location @frontend {
#         proxy_pass http://frontend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }














































# upstream backend {
#     server app-prod:8000;
# }

# upstream frontend {
#     server frontend-production:3000;
# }

# upstream y-provider {
#     server y-provider-production:4444;
# }

# upstream minio {
#     server minio:9000;
# }

# server {
#     listen 80;
#     server_name localhost;
#     charset utf-8;
#     client_max_body_size 100M;

#     # CORS and Security headers
#     add_header X-Frame-Options DENY always;
#     add_header X-Content-Type-Options nosniff always;
#     add_header X-XSS-Protection "1; mode=block" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header Access-Control-Allow-Origin "*" always;
#     add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
#     add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    
#     # Gzip compression
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1000;
#     gzip_types
#         text/plain
#         text/css
#         text/xml
#         text/javascript
#         application/xml+rss
#         application/javascript
#         application/json
#         image/svg+xml;

#     # Static files
#     location /static/ {
#         alias /data/static/;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         add_header Access-Control-Allow-Origin "*";
#     }

#     # API routes
#     location /api/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_redirect off;
        
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#     }

#     # Admin routes
#     location /admin/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_redirect off;
#     }

#     # Authentication routes
#     location /oidc/ {
#         proxy_pass http://backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_redirect off;
#     }

#     # Media files with auth
#     location /media/ {
#         auth_request /media-auth;
#         auth_request_set $authHeader $upstream_http_authorization;
#         auth_request_set $authDate $upstream_http_x_amz_date;
#         auth_request_set $authContentSha256 $upstream_http_x_amz_content_sha256;

#         proxy_set_header Authorization $authHeader;
#         proxy_set_header X-Amz-Date $authDate;
#         proxy_set_header X-Amz-Content-SHA256 $authContentSha256;

#         proxy_pass http://minio/grow24-office-docs-media-storage/;
#         proxy_set_header Host minio:9000;

#         add_header Cache-Control "private, max-age=3600";
#         add_header Access-Control-Allow-Origin "*";
#     }

#     location /media-auth {
#         internal;
#         proxy_pass http://backend/api/v1.0/documents/media-auth/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Original-URL $request_uri;
#         proxy_pass_request_body off;
#         proxy_set_header Content-Length "";
#         proxy_set_header X-Original-Method $request_method;
#         proxy_set_header X-Forwarded-Proto https;
#     }

#     # Collaboration WebSocket with auth
#     location /collaboration/ws/ {
#         auth_request /collaboration-auth;
        
#         proxy_pass http://y-provider;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_cache_bypass $http_upgrade;
#         proxy_read_timeout 86400;
#     }

#     # Collaboration API with auth
#     location /collaboration/ {
#         auth_request /collaboration-auth;
        
#         proxy_pass http://y-provider;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#     }

#     location /collaboration-auth {
#         internal;
#         proxy_pass http://backend/api/v1.0/collaboration-auth/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_pass_request_body off;
#         proxy_set_header Content-Length "";
#         proxy_set_header X-Original-Method $request_method;
#         proxy_set_header X-Forwarded-Proto https;
#     }

#     # Health checks
#     location /health {
#         access_log off;
#         return 200 "healthy\n";
#         add_header Content-Type text/plain;
#     }

#     # Frontend (catch-all)
#     location / {
#         proxy_pass http://frontend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_redirect off;
        
#         try_files $uri $uri/ @frontend;
#     }

#     location @frontend {
#         proxy_pass http://frontend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#     }
# }
















# upstream docs_backend {
#     server app-prod:8000 fail_timeout=0;
# }

# upstream docs_frontend {
#     server frontend-production:3000 fail_timeout=0;
# }

# server {
#     listen 80;
#     server_name localhost;
#     charset utf-8;
#     client_max_body_size 100M;

#     # Disables server version feedback on pages and in headers
#     server_tokens off;

#     proxy_ssl_server_name on;

#     location @proxy_to_docs_backend {
#         proxy_set_header Host $http_host;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

#         proxy_redirect off;
#         proxy_pass http://docs_backend;
#     }

#     location @proxy_to_docs_frontend {
#         proxy_set_header Host $http_host;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

#         proxy_redirect off;
#         proxy_pass http://docs_frontend;
#     }

#     location / {
#         try_files $uri @proxy_to_docs_frontend;
#     }

#     location /api {
#         try_files $uri @proxy_to_docs_backend;
#     }

#     location /admin {
#         try_files $uri @proxy_to_docs_backend;
#     }

#     location /static {
#         try_files $uri @proxy_to_docs_backend;
#     }

#     location /oidc/ {
#         proxy_pass http://docs_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_redirect off;
#     }

#     # Proxy auth for collaboration server
#     location /collaboration/ws/ {
#         # Ensure WebSocket upgrade
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "Upgrade";

#         # Collaboration server
#         proxy_pass http://y-provider-production:4444;

#         # Set appropriate timeout for WebSocket
#         proxy_read_timeout 86400;
#         proxy_send_timeout 86400;

#         # Preserve original host and additional headers
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_set_header Origin $http_origin;
#         proxy_set_header Host $host;
#     }

#     location  /collaboration/api/ {
#         # Collaboration server
#         proxy_pass http://y-provider-production:4444;
#         proxy_set_header Host $host;
#     }

#     # Proxy auth for media
#     location /media/ {
#         # Auth request configuration
#         auth_request /media-auth;
#         auth_request_set $authHeader $upstream_http_authorization;
#         auth_request_set $authDate $upstream_http_x_amz_date;
#         auth_request_set $authContentSha256 $upstream_http_x_amz_content_sha256;

#         # Pass specific headers from the auth response
#         proxy_set_header Authorization $authHeader;
#         proxy_set_header X-Amz-Date $authDate;
#         proxy_set_header X-Amz-Content-SHA256 $authContentSha256;

#         # Get resource from Minio
#         proxy_pass http://minio:9000/grow24-office-docs-media-storage/;
#         proxy_set_header Host minio:9000;

#         proxy_ssl_name minio:9000;

#         add_header Content-Security-Policy "default-src 'none'" always;
#     }
    
#     location /media-auth {
#         proxy_pass http://docs_backend/api/v1.0/documents/media-auth/;
#         proxy_set_header X-Forwarded-Proto https;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Original-URL $request_uri;

#         # Prevent the body from being passed
#         proxy_pass_request_body off;
#         proxy_set_header Content-Length "";
#         proxy_set_header X-Original-Method $request_method;
#     }
# }








upstream docs_backend {
    server app-prod:8000 fail_timeout=0;
}

upstream docs_frontend {
    server frontend-production:3000 fail_timeout=0;
}

server {
    listen 80;
    server_name localhost;
    charset utf-8;
    client_max_body_size 100M;

    # Disables server version feedback on pages and in headers
    server_tokens off;

    proxy_ssl_server_name on;

    location @proxy_to_docs_backend {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_pass http://docs_backend;
    }

    location @proxy_to_docs_frontend {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_pass http://docs_frontend;
    }

    location / {
        try_files $uri @proxy_to_docs_frontend;
    }

    location /api {
        try_files $uri @proxy_to_docs_backend;
    }

    location /admin {
        try_files $uri @proxy_to_docs_backend;
    }

    location /static {
        try_files $uri @proxy_to_docs_backend;
    }

    location /oidc/ {
        proxy_pass http://docs_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_redirect off;
    }

    # FIXED: WebSocket proxy for collaboration - This should NOT be here when Apache handles it directly
    # Comment out or remove these blocks since Apache now handles collaboration directly
    # location /collaboration/ws/ {
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "Upgrade";
    #     proxy_pass http://y-provider-production:4444;
    #     proxy_read_timeout 86400;
    #     proxy_send_timeout 86400;
    #     proxy_set_header X-Forwarded-Proto https;
    #     proxy_set_header Origin $http_origin;
    #     proxy_set_header Host $host;
    # }

    # FIXED: Collaboration API - This should NOT be here when Apache handles it directly
    # location  /collaboration/api/ {
    #     proxy_pass http://y-provider-production:4444;
    #     proxy_set_header Host $host;
    # }

    # FIXED: Media proxy with corrected path handling
    location /media/ {
        # Auth request configuration
        auth_request /media-auth;
        auth_request_set $authHeader $upstream_http_authorization;
        auth_request_set $authDate $upstream_http_x_amz_date;
        auth_request_set $authContentSha256 $upstream_http_x_amz_content_sha256;

        # Pass specific headers from the auth response
        proxy_set_header Authorization $authHeader;
        proxy_set_header X-Amz-Date $authDate;
        proxy_set_header X-Amz-Content-SHA256 $authContentSha256;

        # FIXED: Remove the trailing slash to prevent double path
        # This was causing /media/media/ in URLs
        proxy_pass http://minio:9000/grow24-office-docs-media-storage;
        proxy_set_header Host minio:9000;

        proxy_ssl_name minio:9000;

        add_header Content-Security-Policy "default-src 'none'" always;
    }
    
    location /media-auth {
        proxy_pass http://docs_backend/api/v1.0/documents/media-auth/;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Original-URL $request_uri;

        # Prevent the body from being passed
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-Method $request_method;
    }
}