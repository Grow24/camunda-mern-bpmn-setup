# # Header set X-Vhost "grow24_docs"

# # SSLProxyEngine on
# # ProxyPreserveHost On

# # RequestHeader set X-Forwarded-Proto "https"
    
# # # Security Headers
# # # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
# # # Header always set X-Frame-Options "DENY"
# # # Header always set X-Content-Type-Options "nosniff"
# # # Header always set X-XSS-Protection "1; mode=block"
# # # Header always set Referrer-Policy "strict-origin-when-cross-origin"
# # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:; media-src 'self'; object-src 'none'; frame-ancestors 'none';"
    
# #     # Remove server signature
# #     # Header always unset Server
# #     # Header always set Server "Apache"
    
# #     # Proxy Configuration
# #     ProxyPreserveHost On
# #     ProxyRequests Off
# #     ProxyTimeout 300
# #     ProxyBadHeader Ignore
    
# # # Set proxy headers for all requests
# # ProxyPassMatch ^/(.*) http://118.139.165.145:20080/$1
# # ProxyPassReverse / http://118.139.165.145:20080/

# # # WebSocket support for collaboration
# # RewriteEngine On
# # RewriteCond %{HTTP:Upgrade} websocket [NC]
# # RewriteCond %{HTTP:Connection} upgrade [NC]
# # RewriteRule ^/collaboration/ws/(.*) ws://118.139.165.145:20004/collaboration/ws/$1 [P,L]

# # # Direct API routing for better performance
# # ProxyPass /api/ http://118.139.165.145:20001/api/ retry=3 timeout=60
# # ProxyPassReverse /api/ http://118.139.165.145:20001/api/

# # ProxyPass /admin/ http://118.139.165.145:20001/admin/ retry=3 timeout=60
# # ProxyPassReverse /admin/ http://118.139.165.145:20001/admin/

# # ProxyPass /oidc/ http://118.139.165.145:20001/oidc/ retry=3 timeout=60
# # ProxyPassReverse /oidc/ http://118.139.165.145:20001/oidc/

# # # Collaboration API (non-WebSocket)
# # ProxyPass /collaboration/api/ http://118.139.165.145:20004/collaboration/api/ retry=3 timeout=60
# # ProxyPassReverse /collaboration/api/ http://118.139.165.145:20004/collaboration/api/

# # # Health check endpoint
# # ProxyPass /health http://118.139.165.145:20080/health retry=1 timeout=5
# # ProxyPassReverse /health http://118.139.165.145:20080/health

# # # Set headers for proxied requests
# # <LocationMatch "^/(api|admin|oidc|collaboration)/">
# #     ProxyPassReverse /
# #     RequestHeader set X-Forwarded-Proto "https"
# #     RequestHeader set X-Forwarded-Port "443"
# #     RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
# #     RequestHeader set X-Real-IP %{REMOTE_ADDR}s
# # </LocationMatch>

# # # Static files caching
# # <LocationMatch "^/static/">
# #     ExpiresActive On
# #     ExpiresDefault "access plus 1 year"
# #     Header append Cache-Control "public, immutable"
# # </LocationMatch>

# # # Media files caching (shorter cache time due to auth)
# # <LocationMatch "^/media/">
# #     ExpiresActive On
# #     ExpiresDefault "access plus 1 hour"
# #     Header append Cache-Control "private, must-revalidate"
# # </LocationMatch>

# # # Compression for better performance
# # <LocationMatch "\.(css|js|html|xml|txt|json)$">
# #     SetOutputFilter DEFLATE
# #     SetEnvIfNoCase Request_URI \
# #         \.(?:gif|jpe?g|png|ico|woff2?|ttf|eot|svg)$ no-gzip dont-vary
# #     SetEnvIfNoCase Request_URI \
# #         \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
# # </LocationMatch>
    
# #     # Rate limiting (optional - requires mod_evasive)
# #     # DOSHashTableSize    65536
# #     # DOSPageCount        10
# #     # DOSPageInterval     1
# #     # DOSSiteCount        50
# #     # DOSSiteInterval     1
# #     # DOSBlockingPeriod   60
    
# #     # Logging
# #     LogLevel warn
# #     ErrorLog ${APACHE_LOG_DIR}/docs_error.log
# #     CustomLog ${APACHE_LOG_DIR}/docs_access.log combined
    
# #     # Log proxy errors separately
# #     LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_with_time
# #     CustomLog ${APACHE_LOG_DIR}/docs_proxy.log combined_with_time
    
# #     # Block common attack patterns
# #     <LocationMatch "(wp-admin|wp-login|xmlrpc|\.php)">
# #         Require all denied
# #     </LocationMatch>
    
# #     # Block sensitive files
# #     <FilesMatch "\.(env|conf|config|log|bak|backup|old)$">
# #         Require all denied
# #     </FilesMatch>
    
# #     # Prevent access to Docker socket (security)
# #     <LocationMatch "docker">
# #         Require all denied
# #     </LocationMatch>




















































































# Header set X-Vhost "grow24_docs"

# SSLProxyEngine on
# ProxyPreserveHost On
# ProxyRequests Off
# ProxyTimeout 300
# ProxyBadHeader Ignore

# RequestHeader set X-Forwarded-Proto "https"

# # Security Headers
# # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
# # Header always set X-Frame-Options "DENY"
# # Header always set X-Content-Type-Options "nosniff"
# # Header always set X-XSS-Protection "1; mode=block"
# # Header always set Referrer-Policy "strict-origin-when-cross-origin"
# # Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss: https:; media-src 'self'; object-src 'none'; frame-ancestors 'none';"
# # Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' wss: https:; media-src 'self'; object-src 'none'; frame-ancestors 'none';"

# Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://docs.intelligentsalesman.com http://118.139.165.145:20009; connect-src 'self' wss://docs.intelligentsalesman.com https://docs.intelligentsalesman.com; media-src 'self'; object-src 'none'; frame-ancestors 'none';"

# # Proxy rules for API & components
# ProxyPass /api/ http://118.139.165.145:20001/api/ retry=3 timeout=60
# ProxyPassReverse /api/ http://118.139.165.145:20001/api/

# ProxyPass /admin/ http://118.139.165.145:20001/admin/ retry=3 timeout=60
# ProxyPassReverse /admin/ http://118.139.165.145:20001/admin/

# ProxyPass /oidc/ http://118.139.165.145:20001/oidc/ retry=3 timeout=60
# ProxyPassReverse /oidc/ http://118.139.165.145:20001/oidc/

# # ProxyPass /collaboration/api/ http://118.139.165.145:20004/collaboration/api/ retry=3 timeout=60
# # ProxyPassReverse /collaboration/api/ http://118.139.165.145:20004/collaboration/api/

# # ProxyPass /collaboration/ws/ ws://118.139.165.145:20004/collaboration/ws/
# # ProxyPassReverse /collaboration/ws/ ws://118.139.165.145:20004/collaboration/ws/

# ProxyPass /health http://118.139.165.145:20080/health retry=1 timeout=5
# ProxyPassReverse /health http://118.139.165.145:20080/health

# # ProxyPass /media/ http://118.139.165.145:20080/media/ retry=3 timeout=60
# # ProxyPassReverse /media/ http://118.139.165.145:20080/media/

# ProxyPass /media/ http://118.139.165.145:20080/media/ retry=3 timeout=60
# ProxyPassReverse /media/ http://118.139.165.145:20080/media/

# ProxyPass /collaboration/ http://118.139.165.145:20080/collaboration/ retry=3 timeout=60
# ProxyPassReverse /collaboration/ http://118.139.165.145:20080/collaboration/

# # Fallback proxy for all other routes
# ProxyPassMatch ^/(.*) http://118.139.165.145:20080/$1
# ProxyPassReverse / http://118.139.165.145:20080/

# # Set headers for proxied requests
# <LocationMatch "^/(api|admin|oidc|collaboration)/">
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Port "443"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e" env=REMOTE_ADDR
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}e" env=REMOTE_ADDR
# </LocationMatch>

# # Static files caching
# <LocationMatch "^/static/">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 year"
#     Header set Cache-Control "public, immutable"
# </LocationMatch>

# # Media files caching
# <LocationMatch "^/media/">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 hour"
#     Header set Cache-Control "private, must-revalidate"
# </LocationMatch>

# # Compression
# <LocationMatch "\.(css|js|html|xml|txt|json)$">
#     SetOutputFilter DEFLATE
#     SetEnvIfNoCase Request_URI \
#         \.(?:gif|jpe?g|png|ico|woff2?|ttf|eot|svg)$ no-gzip dont-vary
#     SetEnvIfNoCase Request_URI \
#         \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
# </LocationMatch>

# # Logging
# # LogLevel warn
# # ErrorLog ${APACHE_LOG_DIR}/docs_error.log
# # CustomLog ${APACHE_LOG_DIR}/docs_access.log combined
# # LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_with_time
# # CustomLog ${APACHE_LOG_DIR}/docs_proxy.log combined_with_time

# # Security – block common attacks
# <LocationMatch "(wp-admin|wp-login|xmlrpc|\.php)">
#     Require all denied
# </LocationMatch>

# # Block sensitive files
# <FilesMatch "\.(env|conf|config|log|bak|backup|old)$">
#     Require all denied
# </FilesMatch>

# # Block VCS and hidden files
# <FilesMatch "^\.git|\.svn|\.hg|\.ht">
#     Require all denied
# </FilesMatch>

# # Block docker socket access
# <LocationMatch "docker">
#     Require all denied
# </LocationMatch>








































# Header set X-Vhost "grow24_docs"

# SSLProxyEngine on
# ProxyPreserveHost On
# ProxyRequests Off
# ProxyTimeout 300
# ProxyBadHeader Ignore

# RequestHeader set X-Forwarded-Proto "https"

# # FIXED Content Security Policy - Allow necessary sources
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data: https: blob:; connect-src 'self' wss: https:; media-src 'self' blob:; object-src 'none'; frame-ancestors 'none'; worker-src 'self' blob:;"

# # Proxy rules for API & components
# ProxyPass /api/ http://118.139.165.145:20001/api/ retry=3 timeout=60
# ProxyPassReverse /api/ http://118.139.165.145:20001/api/

# ProxyPass /admin/ http://118.139.165.145:20001/admin/ retry=3 timeout=60
# ProxyPassReverse /admin/ http://118.139.165.145:20001/admin/

# ProxyPass /oidc/ http://118.139.165.145:20001/oidc/ retry=3 timeout=60
# ProxyPassReverse /oidc/ http://118.139.165.145:20001/oidc/

# # WebSocket support for collaboration
# RewriteEngine On
# RewriteCond %{HTTP:Upgrade} websocket [NC]
# RewriteCond %{HTTP:Connection} upgrade [NC]
# RewriteRule ^/collaboration/ws/(.*) ws://118.139.165.145:20080/collaboration/ws/$1 [P,L]

# ProxyPass /collaboration/ http://118.139.165.145:20080/collaboration/ retry=3 timeout=60
# ProxyPassReverse /collaboration/ http://118.139.165.145:20080/collaboration/

# ProxyPass /media/ http://118.139.165.145:20080/media/ retry=3 timeout=60
# ProxyPassReverse /media/ http://118.139.165.145:20080/media/

# ProxyPass /health http://118.139.165.145:20080/health retry=1 timeout=5
# ProxyPassReverse /health http://118.139.165.145:20080/health

# # Fallback proxy for all other routes
# ProxyPassMatch ^/(.*) http://118.139.165.145:20080/$1
# ProxyPassReverse / http://118.139.165.145:20080/

# # Set headers for proxied requests
# <LocationMatch "^/(api|admin|oidc|collaboration)/">
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Port "443"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e" env=REMOTE_ADDR
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}e" env=REMOTE_ADDR
# </LocationMatch>

# # Static files caching
# <LocationMatch "^/static/">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 year"
#     Header set Cache-Control "public, immutable"
# </LocationMatch>

# # Media files caching
# <LocationMatch "^/media/">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 hour"
#     Header set Cache-Control "private, must-revalidate"
# </LocationMatch>

# # Compression
# <LocationMatch "\.(css|js|html|xml|txt|json)$">
#     SetOutputFilter DEFLATE
#     SetEnvIfNoCase Request_URI \
#         \.(?:gif|jpe?g|png|ico|woff2?|ttf|eot|svg)$ no-gzip dont-vary
#     SetEnvIfNoCase Request_URI \
#         \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
# </LocationMatch>

# # Security – block common attacks
# <LocationMatch "(wp-admin|wp-login|xmlrpc|\.php)">
#     Require all denied
# </LocationMatch>

# <FilesMatch "\.(env|conf|config|log|bak|backup|old)$">
#     Require all denied
# </FilesMatch>

# <FilesMatch "^\.git|\.svn|\.hg|\.ht">
#     Require all denied
# </FilesMatch>

# <LocationMatch "docker">
#     Require all denied
# </LocationMatch>











# # Set virtual host header
# Header set X-Vhost "grow24_docs"

# # Enable reverse proxy and security
# SSLProxyEngine on
# ProxyPreserveHost On
# ProxyRequests Off
# ProxyTimeout 300
# ProxyBadHeader Ignore

# # HTTPS forwarding
# RequestHeader set X-Forwarded-Proto "https"
# RequestHeader set X-Forwarded-Port "443"
# RequestHeader set X-Real-IP "%{REMOTE_ADDR}e" env=REMOTE_ADDR
# RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e" env=REMOTE_ADDR

# # Security headers
# Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data: https: blob:; connect-src 'self' wss: https: http:; media-src 'self' blob:; object-src 'none'; frame-ancestors 'none'; worker-src 'self' blob:;"
# Header always set X-Frame-Options DENY
# Header always set X-Content-Type-Options nosniff
# Header always set Referrer-Policy "strict-origin-when-cross-origin"
# Header always set X-XSS-Protection "1; mode=block"

# # API proxy
# ProxyPass /api/ http://118.139.165.145:20080/api/ retry=3 timeout=60
# ProxyPassReverse /api/ http://118.139.165.145:20080/api/

# # Admin proxy
# ProxyPass /admin/ http://118.139.165.145:20080/admin/ retry=3 timeout=60
# ProxyPassReverse /admin/ http://118.139.165.145:20080/admin/

# # OIDC / Auth proxy
# ProxyPass /oidc/ http://118.139.165.145:20080/oidc/ retry=3 timeout=60
# ProxyPassReverse /oidc/ http://118.139.165.145:20080/oidc/

# # Media files
# <LocationMatch "^/media/">
#     ProxyPass http://118.139.165.145:20080/media/ retry=3 timeout=60
#     ProxyPassReverse http://118.139.165.145:20080/media/

#     # Forward AWS-style auth headers from frontend to backend
#     RequestHeader set Authorization %{HTTP:Authorization}e env=HTTP_AUTHORIZATION
#     RequestHeader set X-Amz-Date %{HTTP:X-Amz-Date}e env=HTTP_X_AMZ_DATE
#     RequestHeader set X-Amz-Content-SHA256 %{HTTP:X-Amz-Content-SHA256}e env=HTTP_X_AMZ_CONTENT_SHA256

#     # Also set real IP and proto
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}e"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}e"
#     RequestHeader set X-Forwarded-Proto "https"

#     Header set Cache-Control "private, max-age=3600"
# </LocationMatch>


# # WebSocket for collaboration (Apache 2.4+ with mod_proxy_wstunnel enabled)
# # WebSocket support for collaboration
# ProxyPass "/collaboration/ws/"  "ws://118.139.165.145:20080/collaboration/ws/"
# ProxyPassReverse "/collaboration/ws/" "ws://118.139.165.145:20080/collaboration/ws/"

# # Ensure upgrade headers are passed
# <Location "/collaboration/ws/">
#     ProxyPreserveHost On
#     ProxyPassReverse "ws://118.139.165.145:20080/collaboration/ws/"
#     RequestHeader set Upgrade "websocket"
#     RequestHeader set Connection "Upgrade"
#     RequestHeader set X-Forwarded-Proto "https"
# </Location>

# # Collaboration REST API
# ProxyPass /collaboration/ http://118.139.165.145:20080/collaboration/ retry=3 timeout=60
# ProxyPassReverse /collaboration/ http://118.139.165.145:20080/collaboration/

# # Healthcheck
# ProxyPass /health http://118.139.165.145:20080/health retry=1 timeout=5
# ProxyPassReverse /health http://118.139.165.145:20080/health

# # Static file cache control
# <LocationMatch "^/static/">
#     ExpiresActive On
#     ExpiresDefault "access plus 1 year"
#     Header set Cache-Control "public, immutable"
# </LocationMatch>

# # Compression for frontend assets
# <LocationMatch "\.(css|js|html|xml|txt|json)$">
#     SetOutputFilter DEFLATE
#     SetEnvIfNoCase Request_URI \
#         \.(?:gif|jpe?g|png|ico|woff2?|ttf|eot|svg)$ no-gzip dont-vary
# </LocationMatch>

# # SPA frontend fallback (e.g. React)
# ProxyPass / http://118.139.165.145:20080/
# ProxyPassReverse / http://118.139.165.145:20080/

# # Extra security: deny access to sensitive files
# <FilesMatch "\.(env|conf|config|log|bak|backup|old)$">
#     Require all denied
# </FilesMatch>

# <FilesMatch "^\.git|\.svn|\.hg|\.ht">
#     Require all denied
# </FilesMatch>

# <LocationMatch "(wp-admin|wp-login|xmlrpc|\.php|docker)">
#     Require all denied
# </LocationMatch>












































# # Set virtual host header
# Header set X-Vhost "grow24_docs"

# # Apache SSL Proxy Configuration for La Suite Docs
# # File: /etc/apache2/conf.d/userdata/ssl/2_4/intelligents/docs.intelligentsalesman.com/custom_proxy.conf

# # Enable required modules (ensure these are loaded)
# # LoadModule proxy_module modules/mod_proxy.so
# # LoadModule proxy_http_module modules/mod_proxy_http.so
# # LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# # LoadModule headers_module modules/mod_headers.so
# # LoadModule rewrite_module modules/mod_rewrite.so

# # Proxy settings
# ProxyPreserveHost On
# ProxyRequests Off

# # Set timeout for WebSocket connections
# ProxyTimeout 86400

# # Define proxy balancers for load balancing (optional, but good practice)
# # ProxyPass /balancer-manager !
# # ProxyPassMatch ^/balancer-manager$ !

# # WebSocket proxy for collaboration (MUST be first to match correctly)
# # This handles the real-time collaboration WebSocket connections
# RewriteEngine On
# RewriteCond %{HTTP:Upgrade} websocket [NC]
# RewriteCond %{HTTP:Connection} upgrade [NC]
# RewriteRule ^/collaboration/ws/(.*)$ ws://127.0.0.1:20004/collaboration/ws/$1 [P,L]

# # Fallback for non-WebSocket requests to collaboration
# ProxyPassMatch ^/collaboration/ws/(.*)$ http://127.0.0.1:20004/collaboration/ws/$1
# ProxyPassReverse /collaboration/ws/ http://127.0.0.1:20004/collaboration/ws/

# # Collaboration API endpoints - with proper headers
# <Location "/collaboration/api/">
#     ProxyPass http://127.0.0.1:20004/collaboration/api/
#     ProxyPassReverse http://127.0.0.1:20004/collaboration/api/
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
# </Location>

# # Media authentication endpoint (for secure media access)
# <Location "/media-auth">
#     ProxyPass http://127.0.0.1:20080/media-auth
#     ProxyPassReverse http://127.0.0.1:20080/media-auth
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     RequestHeader set X-Original-URL "%{REQUEST_URI}s"
#     RequestHeader set X-Original-Method "%{REQUEST_METHOD}s"
# </Location>

# # Media files proxy with authentication
# <Location "/media/">
#     ProxyPass http://127.0.0.1:20080/media/
#     ProxyPassReverse http://127.0.0.1:20080/media/
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
# </Location>

# # Backend API endpoints
# ProxyPass /api/ http://127.0.0.1:20080/api/
# ProxyPassReverse /api/ http://127.0.0.1:20080/api/

# # Django admin interface
# ProxyPass /admin/ http://127.0.0.1:20080/admin/
# ProxyPassReverse /admin/ http://127.0.0.1:20080/admin/

# # Static files (CSS, JS, images)
# ProxyPass /static/ http://127.0.0.1:20080/static/
# ProxyPassReverse /static/ http://127.0.0.1:20080/static/

# # OIDC authentication endpoints (Keycloak integration)
# ProxyPass /oidc/ http://127.0.0.1:20080/oidc/
# ProxyPassReverse /oidc/ http://127.0.0.1:20080/oidc/

# # Health check endpoints
# ProxyPass /health http://127.0.0.1:20080/health
# ProxyPassReverse /health http://127.0.0.1:20080/health

# # All other requests go to frontend (React app)
# # This should be last to catch all remaining requests
# ProxyPass / http://127.0.0.1:20080/
# ProxyPassReverse / http://127.0.0.1:20080/

# # Security headers for enhanced protection
# Header always set X-Content-Type-Options nosniff
# Header always set X-Frame-Options DENY
# Header always set X-XSS-Protection "1; mode=block"
# Header always set Referrer-Policy "strict-origin-when-cross-origin"
# Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# # HSTS (HTTP Strict Transport Security)
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# # Content Security Policy for media files
# <LocationMatch "^/media/">
#     Header always set Content-Security-Policy "default-src 'none'"
# </LocationMatch>

# # WebSocket specific headers for collaboration
# <LocationMatch "^/collaboration/ws/">
#     ProxyPassReverse /
#     ProxyPreserveHost On
    
#     RequestHeader unset Authorization
#     RequestHeader unset Cookie
#     RequestHeader append X-Forwarded-Proto "https"
#     RequestHeader append X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader append X-Real-IP "%{REMOTE_ADDR}s"
    
#     RequestHeader set Upgrade "%{HTTP:Upgrade}s"
#     RequestHeader set Connection "%{HTTP:Connection}s"
#     RequestHeader set Sec-WebSocket-Key "%{HTTP:Sec-WebSocket-Key}s"
#     RequestHeader set Sec-WebSocket-Version "%{HTTP:Sec-WebSocket-Version}s"
#     RequestHeader set Sec-WebSocket-Protocol "%{HTTP:Sec-WebSocket-Protocol}s"
    
#     ProxyTimeout 3600
#     ProxyBadHeader Ignore
# </LocationMatch>

# # # Logging for debugging (optional - remove in production)
# # LogLevel info
# # ErrorLog logs/docs_ssl_error.log
# # CustomLog logs/docs_ssl_access.log combined

# # Ensure proper handling of HTTPS in backend
# RequestHeader set X-Forwarded-Proto "https"
# RequestHeader set X-Forwarded-Port "443"

# # Handle large file uploads (100MB limit)
# LimitRequestBody 104857600

# # Compression for better performance
# <Location />
#     SetOutputFilter DEFLATE
#     SetEnvIfNoCase Request_URI \
#         \.(?:gif|jpe?g|png|ico|pdf|zip|gz|bz2|rar|7z)$ no-gzip dont-vary
#     SetEnvIfNoCase Request_URI \
#         \.(?:avi|mov|mp4|mp3|ogg|webm)$ no-gzip dont-vary
# </Location>








# # Apache SSL Proxy Configuration for La Suite Docs - FIXED VERSION
# # File: /etc/apache2/conf.d/userdata/ssl/2_4/intelligents/docs.intelligentsalesman.com/custom_proxy.conf

# # Set virtual host header
# Header set X-Vhost "grow24_docs"

# # Enable required modules (ensure these are loaded)
# # LoadModule proxy_module modules/mod_proxy.so
# # LoadModule proxy_http_module modules/mod_proxy_http.so
# # LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# # LoadModule headers_module modules/mod_headers.so
# # LoadModule rewrite_module modules/mod_rewrite.so

# # Proxy settings
# ProxyPreserveHost On
# ProxyRequests Off

# # Set timeout for WebSocket connections
# ProxyTimeout 86400

# # CRITICAL FIX: WebSocket proxy for collaboration - Direct to y-provider service
# # This handles the real-time collaboration WebSocket connections
# RewriteEngine On
# RewriteCond %{HTTP:Upgrade} =websocket [NC]
# RewriteCond %{HTTP:Connection} upgrade [NC]
# RewriteRule ^/collaboration/ws/(.*)$ ws://127.0.0.1:20004/collaboration/ws/$1 [P,L]

# # CRITICAL FIX: Collaboration WebSocket location block - Direct to y-provider
# <Location "/collaboration/ws/">
#     ProxyPass ws://127.0.0.1:20004/collaboration/ws/
#     ProxyPassReverse ws://127.0.0.1:20004/collaboration/ws/
#     ProxyPreserveHost On
    
#     # WebSocket specific headers
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
    
#     # Preserve WebSocket headers
#     RequestHeader set Upgrade "%{HTTP:Upgrade}s"
#     RequestHeader set Connection "upgrade"
    
#     # Extended timeout for WebSocket
#     ProxyTimeout 86400
#     ProxyBadHeader Ignore
# </Location>

# # Collaboration API endpoints - Direct to y-provider service
# <Location "/collaboration/api/">
#     ProxyPass http://127.0.0.1:20004/collaboration/api/
#     ProxyPassReverse http://127.0.0.1:20004/collaboration/api/
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"
# </Location>

# # Media authentication endpoint (for secure media access)
# <Location "/media-auth">
#     ProxyPass http://127.0.0.1:20080/media-auth
#     ProxyPassReverse http://127.0.0.1:20080/media-auth
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
#     RequestHeader set X-Original-URL "%{REQUEST_URI}s"
#     RequestHeader set X-Original-Method "%{REQUEST_METHOD}s"
# </Location>

# # FIXED: Media files proxy with authentication - Remove duplicate /media/ path
# <Location "/media/">
#     ProxyPass http://127.0.0.1:20080/media/
#     ProxyPassReverse http://127.0.0.1:20080/media/
#     ProxyPreserveHost On
    
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "%{HTTP_HOST}s"
#     RequestHeader set X-Real-IP "%{REMOTE_ADDR}s"
# </Location>

# # Backend API endpoints
# ProxyPass /api/ http://127.0.0.1:20080/api/
# ProxyPassReverse /api/ http://127.0.0.1:20080/api/

# # Django admin interface
# ProxyPass /admin/ http://127.0.0.1:20080/admin/
# ProxyPassReverse /admin/ http://127.0.0.1:20080/admin/

# # Static files (CSS, JS, images)
# ProxyPass /static/ http://127.0.0.1:20080/static/
# ProxyPassReverse /static/ http://127.0.0.1:20080/static/

# # OIDC authentication endpoints (Keycloak integration)
# ProxyPass /oidc/ http://127.0.0.1:20080/oidc/
# ProxyPassReverse /oidc/ http://127.0.0.1:20080/oidc/

# # Health check endpoints
# ProxyPass /health http://127.0.0.1:20080/health
# ProxyPassReverse /health http://127.0.0.1:20080/health

# # All other requests go to frontend (React app)
# # This should be last to catch all remaining requests
# ProxyPass / http://127.0.0.1:20080/
# ProxyPassReverse / http://127.0.0.1:20080/

# # Security headers for enhanced protection
# Header always set X-Content-Type-Options nosniff
# Header always set X-Frame-Options DENY
# Header always set X-XSS-Protection "1; mode=block"
# Header always set Referrer-Policy "strict-origin-when-cross-origin"
# Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

# # HSTS (HTTP Strict Transport Security)
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# # Content Security Policy for media files
# <LocationMatch "^/media/">
#     Header always set Content-Security-Policy "default-src 'none'"
# </LocationMatch>

# # Ensure proper handling of HTTPS in backend
# RequestHeader set X-Forwarded-Proto "https"
# RequestHeader set X-Forwarded-Port "443"

# # Handle large file uploads (100MB limit)
# LimitRequestBody 104857600

# # Compression for better performance
# <Location />
#     SetOutputFilter DEFLATE
#     SetEnvIfNoCase Request_URI \
#         \.(?:gif|jpe?g|png|ico|pdf|zip|gz|bz2|rar|7z)$ no-gzip dont-vary
#     SetEnvIfNoCase Request_URI \
#         \.(?:avi|mov|mp4|mp3|ogg|webm)$ no-gzip dont-vary
# </Location>











# RewriteEngine On
# RewriteRule ^/media/media/(.*)$ /media/$1 [R=301,L]

# # Enable required modules (uncomment if not already loaded)
# # LoadModule proxy_module modules/mod_proxy.so
# # LoadModule proxy_http_module modules/mod_proxy_http.so
# # LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# # LoadModule headers_module modules/mod_headers.so
# # LoadModule rewrite_module modules/mod_rewrite.so

# # General proxy settings
# ProxyPreserveHost On
# ProxyRequests Off
# RequestHeader set X-Forwarded-Proto "https"

# # Set vhost header for debugging
# Header set X-Vhost "grow24_docs"

# # Security headers (set in main Apache conf or here)
# Header always set X-Content-Type-Options nosniff
# Header always set X-Frame-Options DENY
# Header always set X-XSS-Protection "1; mode=block"
# Header always set Referrer-Policy "strict-origin-when-cross-origin"
# Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# # WebSocket for collaboration [DIRECT TO Y-PROVIDER]
# RewriteEngine On
# RewriteCond %{HTTP:Upgrade} websocket [NC]
# RewriteCond %{HTTP:Connection} upgrade [NC]
# RewriteRule ^/collaboration/ws/(.*)$ ws://127.0.0.1:20004/collaboration/ws/$1 [P,L]

# # ProxyPass /collaboration/ws/ ws://127.0.0.1:20004/collaboration/ws/
# # ProxyPassReverse /collaboration/ws/ ws://127.0.0.1:20004/collaboration/ws/

# # Collaboration API [DIRECT TO Y-PROVIDER]
# ProxyPass /collaboration/api/ http://127.0.0.1:20004/collaboration/api/
# ProxyPassReverse /collaboration/api/ http://127.0.0.1:20004/collaboration/api/

# # Media auth endpoint [DIRECT TO app-prod]
# ProxyPass /media-auth http://127.0.0.1:20001/media-auth
# ProxyPassReverse /media-auth http://127.0.0.1:20001/media-auth

# # MinIO media proxy (but let Apache do auth_request!)
# ProxyPass /media/ http://127.0.0.1:20009/grow24-office-docs-media-storage/
# ProxyPassReverse /media/ http://127.0.0.1:20009/grow24-office-docs-media-storage/

# # Django backend API and admin [DIRECT TO app-prod]
# ProxyPass /api/ http://127.0.0.1:20001/api/
# ProxyPassReverse /api/ http://127.0.0.1:20001/api/

# ProxyPass /admin/ http://127.0.0.1:20001/admin/
# ProxyPassReverse /admin/ http://127.0.0.1:20001/admin/

# ProxyPass /oidc/ http://127.0.0.1:20001/oidc/
# ProxyPassReverse /oidc/ http://127.0.0.1:20001/oidc/

# ProxyPass /health http://127.0.0.1:20001/health
# ProxyPassReverse /health http://127.0.0.1:20001/health

# # Static files (if you serve them from Django, else serve directly from Apache)
# ProxyPass /static/ http://127.0.0.1:20001/static/
# ProxyPassReverse /static/ http://127.0.0.1:20001/static/

# # All other traffic goes to React frontend [DIRECT TO frontend-production]
# ProxyPass / http://127.0.0.1:20003/
# ProxyPassReverse / http://127.0.0.1:20003/

# # Set client body size
# LimitRequestBody 104857600

# # Gzip
# # AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json

















RewriteEngine On
RewriteRule ^/media/media/(.*)$ /media/$1 [R=301,L]

# General proxy settings
ProxyPreserveHost On
ProxyRequests Off
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Real-IP %{REMOTE_ADDR}s

# Set vhost header for debugging
Header set X-Vhost "grow24_docs"

# Security headers
# Header always set X-Content-Type-Options nosniff
# Header always set X-Frame-Options DENY
# Header always set X-XSS-Protection "1; mode=block"
# Header always set Referrer-Policy "strict-origin-when-cross-origin"
# Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
# Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# WebSocket for collaboration [DIRECT TO Y-PROVIDER]
RewriteCond %{HTTP:Upgrade} websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule ^/collaboration/ws/(.*)$ ws://127.0.0.1:20004/collaboration/ws/$1 [P,L]

# Collaboration API [DIRECT TO Y-PROVIDER]
ProxyPass /collaboration/api/ http://127.0.0.1:20004/collaboration/api/
ProxyPassReverse /collaboration/api/ http://127.0.0.1:20004/collaboration/api/

# Media authentication endpoint [DIRECT TO app-prod]
ProxyPass /media-auth http://127.0.0.1:20001/media-auth
ProxyPassReverse /media-auth http://127.0.0.1:20001/media-auth

# Media files - Simplified approach without auth_request
# Direct proxy to MinIO with headers
ProxyPass /media/ http://127.0.0.1:20009/grow24-office-docs-media-storage/
ProxyPassReverse /media/ http://127.0.0.1:20009/grow24-office-docs-media-storage/

# Add headers for MinIO media access
<LocationMatch "^/media/">
    RequestHeader unset Authorization
    RequestHeader set Host "127.0.0.1:20009"
    # Allow CORS for media
    Header set Access-Control-Allow-Origin "https://docs.intelligentsalesman.com"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
</LocationMatch>

# Django backend API and admin [DIRECT TO app-prod]
ProxyPass /api/ http://127.0.0.1:20001/api/
ProxyPassReverse /api/ http://127.0.0.1:20001/api/

ProxyPass /admin/ http://127.0.0.1:20001/admin/
ProxyPassReverse /admin/ http://127.0.0.1:20001/admin/

ProxyPass /oidc/ http://127.0.0.1:20001/oidc/
ProxyPassReverse /oidc/ http://127.0.0.1:20001/oidc/

ProxyPass /health http://127.0.0.1:20001/health
ProxyPassReverse /health http://127.0.0.1:20001/health

# Static files
ProxyPass /static/ http://127.0.0.1:20001/static/
ProxyPassReverse /static/ http://127.0.0.1:20001/static/

# All other traffic goes to React frontend [DIRECT TO frontend-production]
ProxyPass / http://127.0.0.1:20003/
ProxyPassReverse / http://127.0.0.1:20003/

# Set client body size
LimitRequestBody 104857600